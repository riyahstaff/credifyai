
import { Letter } from './sampleLettersData';

/**
 * Loads letters from session storage
 */
export const loadLettersFromStorage = (): { 
  letters: Letter[], 
  selectedLetter: Letter | null,
  foundLetters: boolean
} => {
  const generatedLettersJSON = sessionStorage.getItem('generatedDisputeLetters');
  const pendingLetterJSON = sessionStorage.getItem('pendingDisputeLetter');
  const autoGeneratedFlag = sessionStorage.getItem('autoGeneratedLetter');
  
  console.log("[loadLettersFromStorage] Auto-generated flag:", autoGeneratedFlag);
  console.log("[loadLettersFromStorage] Generated letters JSON exists:", !!generatedLettersJSON);
  console.log("[loadLettersFromStorage] Pending letter JSON exists:", !!pendingLetterJSON);
  
  if (generatedLettersJSON) {
    console.log("[loadLettersFromStorage] Generated letters JSON content:", generatedLettersJSON.substring(0, 100) + "...");
  }
  
  if (pendingLetterJSON) {
    console.log("[loadLettersFromStorage] Pending letter JSON content:", pendingLetterJSON.substring(0, 100) + "...");
  }
  
  let letters: Letter[] = [];
  let selectedLetter: Letter | null = null;
  let foundLetters = false;
  
  // Try to load multiple letters first
  if (generatedLettersJSON) {
    try {
      const parsedLetters = JSON.parse(generatedLettersJSON);
      console.log("[loadLettersFromStorage] Parsed generated letters:", parsedLetters);
      
      if (Array.isArray(parsedLetters) && parsedLetters.length > 0) {
        console.log(`[loadLettersFromStorage] Found ${parsedLetters.length} generated letters in session storage`);
        
        letters = parsedLetters.map((letter, index) => formatLetterFromStorage(letter, index));
        
        console.log("[loadLettersFromStorage] Formatted letters:", letters);
        
        if (letters.length > 0) {
          selectedLetter = letters[0];
          console.log("[loadLettersFromStorage] Selected first letter:", letters[0]);
        }
        
        foundLetters = true;
        return { letters, selectedLetter, foundLetters };
      }
    } catch (error) {
      console.error("[loadLettersFromStorage] Error parsing generated letters:", error);
    }
  } 
  
  // Fall back to single letter if available
  if (pendingLetterJSON) {
    try {
      const pendingLetter = JSON.parse(pendingLetterJSON);
      console.log("[loadLettersFromStorage] Found pending letter in session storage", pendingLetter);
      
      const formattedLetter = formatLetterFromStorage(pendingLetter, 0);
      letters = [formattedLetter];
      selectedLetter = formattedLetter;
      foundLetters = true;
      
      return { letters, selectedLetter, foundLetters };
    } catch (error) {
      console.error("[loadLettersFromStorage] Error parsing pending letter:", error);
    }
  }
  
  return { letters, selectedLetter, foundLetters };
};

/**
 * Formats a letter from storage to match the Letter interface
 */
export const formatLetterFromStorage = (letter: any, index: number): Letter => {
  // Ensure letter has all required fields
  return {
    id: letter.id || Date.now() + index,
    title: letter.title || `${letter.errorType || 'Dispute'} (${letter.accountName || 'Account'})`,
    recipient: letter.bureau || letter.recipient || 'Credit Bureau',
    createdAt: letter.createdAt || new Date().toLocaleDateString('en-US', { 
      month: 'short', day: 'numeric', year: 'numeric' 
    }),
    status: letter.status || 'draft',
    bureaus: letter.bureaus || [letter.bureau || 'Unknown'],
    // Ensure content is available in both fields for compatibility
    content: letter.letterContent || letter.content || '',
    letterContent: letter.content || letter.letterContent || '',
    accountName: letter.accountName || 'Unknown Account',
    accountNumber: letter.accountNumber || '',
    errorType: letter.errorType || 'General Dispute',
    laws: letter.laws || ["FCRA ยง 611"]
  };
};

/**
 * Saves all letters to session storage
 */
export const saveLettersToStorage = (letters: Letter[], selectedLetter: Letter | null) => {
  try {
    console.log(`[saveLettersToStorage] Saving ${letters.length} letters to storage`);
    sessionStorage.setItem('generatedDisputeLetters', JSON.stringify(letters));
    
    if (selectedLetter) {
      sessionStorage.setItem('pendingDisputeLetter', JSON.stringify(selectedLetter));
    }
    
    sessionStorage.setItem('autoGeneratedLetter', 'true');
    return true;
  } catch (error) {
    console.error("[saveLettersToStorage] Error saving letters to storage:", error);
    return false;
  }
};

/**
 * Adds a single letter to session storage
 */
export const addLetterToStorage = (letter: Letter) => {
  try {
    // First try to get existing letters
    const existingLettersJSON = sessionStorage.getItem('generatedDisputeLetters');
    let letters: Letter[] = [];
    
    if (existingLettersJSON) {
      try {
        const parsed = JSON.parse(existingLettersJSON);
        if (Array.isArray(parsed)) {
          letters = parsed;
        }
      } catch (e) {
        console.error("[addLetterToStorage] Error parsing existing letters:", e);
      }
    }
    
    // Add new letter to the array
    letters.unshift(letter);
    
    // Save updated array
    sessionStorage.setItem('generatedDisputeLetters', JSON.stringify(letters));
    sessionStorage.setItem('pendingDisputeLetter', JSON.stringify(letter));
    sessionStorage.setItem('autoGeneratedLetter', 'true');
    
    return true;
  } catch (error) {
    console.error("[addLetterToStorage] Error adding letter to storage:", error);
    return false;
  }
};
