
import React, { useEffect, useState } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import DisputeLettersPage from '../components/disputes/letters/DisputeLettersPage';
import { useToast } from '@/hooks/use-toast';

const DisputeLetters = () => {
  const { toast } = useToast();
  const location = useLocation();
  const navigate = useNavigate();
  const [lettersLoaded, setLettersLoaded] = useState(false);
  
  // Check if we're in test mode
  const searchParams = new URLSearchParams(location.search);
  const testMode = searchParams.get('testMode') === 'true';

  useEffect(() => {
    // Log test mode status
    if (testMode) {
      console.log("DisputeLetters page: Test mode is active");
    }
    
    // Check for any generated letters when this page loads
    const autoGeneratedFlag = sessionStorage.getItem('autoGeneratedLetter');
    const pendingLetter = sessionStorage.getItem('pendingDisputeLetter');
    const generatedLetters = sessionStorage.getItem('generatedDisputeLetters');
    const forceReload = sessionStorage.getItem('forceLettersReload');
    
    console.log("[DisputeLetters] Checking for auto-generated letter flags");
    console.log("[DisputeLetters] autoGeneratedFlag:", autoGeneratedFlag);
    console.log("[DisputeLetters] pendingLetter:", pendingLetter ? "Present" : "Not present");
    console.log("[DisputeLetters] generatedLetters:", generatedLetters ? "Present" : "Not present");
    console.log("[DisputeLetters] forceReload:", forceReload);
    
    // If force reload is set, remove it and refresh the page
    if (forceReload === 'true') {
      console.log("[DisputeLetters] Force reload detected, refreshing page");
      sessionStorage.removeItem('forceLettersReload');
      
      // Wait a bit to ensure storage operations complete
      setTimeout(() => {
        console.log("[DisputeLetters] Executing forced page reload");
        window.location.reload();
      }, 500);
      return;
    }
    
    // If there are letters, mark them as loaded
    if (pendingLetter || generatedLetters) {
      console.log("[DisputeLetters] Letters found in storage");
      setLettersLoaded(true);
    } 
    // If auto-generated flag is true but no letters found, show error
    else if (autoGeneratedFlag === 'true') {
      console.log("[DisputeLetters] Auto-generated flag is true but no letters found");
      toast({
        title: "No Letters Found",
        description: "We couldn't find any generated dispute letters. Please try generating them again.",
        variant: "destructive",
      });
      sessionStorage.removeItem('autoGeneratedLetter');
      
      // Delay navigation back to upload page
      setTimeout(() => {
        navigate('/upload-report');
      }, 2000);
    }
  }, [toast, testMode, navigate]);

  return (
    <DisputeLettersPage testMode={testMode} />
  );
};

export default DisputeLetters;
