
import React, { useEffect, useState } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import DisputeLettersPage from '../components/disputes/letters/DisputeLettersPage';
import { useToast } from '@/hooks/use-toast';
import { useAuth } from '@/contexts/auth';

const DisputeLetters = () => {
  const { toast } = useToast();
  const location = useLocation();
  const navigate = useNavigate();
  const { profile, user } = useAuth();
  const [lettersLoaded, setLettersLoaded] = useState(false);
  const [loadAttempts, setLoadAttempts] = useState(0);
  
  useEffect(() => {
    console.log("DisputeLetters page: User auth state:", user ? "Logged in" : "Not logged in");
    console.log("DisputeLetters page: Profile:", profile ? `Profile loaded (${profile.full_name || 'no name'})` : "No profile");
    
    // Store profile data in localStorage for letter generation if not already done in AuthProvider
    if (profile) {
      localStorage.setItem('userProfile', JSON.stringify(profile));
      
      if (profile.full_name) {
        localStorage.setItem('userName', profile.full_name);
      }
    }
    
    // Check for letter data
    const pendingLetter = sessionStorage.getItem('pendingDisputeLetter');
    const generatedLetters = sessionStorage.getItem('generatedDisputeLetters');
    const letterGenerationComplete = sessionStorage.getItem('letterGenerationComplete');
    
    console.log("[DisputeLetters] Checking for letter flags");
    console.log("[DisputeLetters] pendingLetter:", pendingLetter ? "Present" : "Not present");
    console.log("[DisputeLetters] generatedLetters:", generatedLetters ? "Present" : "Not present");
    console.log("[DisputeLetters] letterGenerationComplete:", letterGenerationComplete);
    console.log("[DisputeLetters] loadAttempts:", loadAttempts);
    
    let validLetters = false;
    
    if (pendingLetter) {
      try {
        const letterObj = JSON.parse(pendingLetter);
        if (letterObj && letterObj.content && letterObj.content.length > 0) {
          validLetters = true;
          console.log("[DisputeLetters] Letter content found, length:", letterObj.content.length);
          
          if (letterObj.content.includes("Sample dispute letter content") || 
              letterObj.content.length < 100) {
            console.log("[DisputeLetters] Found placeholder content, regenerating letter");
            toast({
              title: "Regenerating Letter",
              description: "The previous letter contained placeholder content. Generating a proper letter now.",
            });
            
            setTimeout(() => {
              navigate('/upload-report');
            }, 2000);
          }
        } else {
          console.warn("[DisputeLetters] Found letter with invalid/placeholder content");
        }
      } catch (e) {
        console.error("[DisputeLetters] Error parsing letter:", e);
      }
    }
    
    if (generatedLetters) {
      try {
        const lettersArray = JSON.parse(generatedLetters);
        if (Array.isArray(lettersArray) && lettersArray.length > 0) {
          validLetters = true;
          console.log("[DisputeLetters] Found valid generated letters array:", lettersArray.length);
        }
      } catch (e) {
        console.error("[DisputeLetters] Error parsing generated letters:", e);
      }
    }
    
    if (validLetters) {
      console.log("[DisputeLetters] Valid letters found in storage");
      setLettersLoaded(true);
      
      // Set a flag to force refresh in component
      sessionStorage.setItem('forceLettersReload', 'true');
      
      // Also enforce auto-generated flag
      sessionStorage.setItem('autoGeneratedLetter', 'true');
    } 
    else if (loadAttempts >= 3) {
      console.log("[DisputeLetters] Maximum load attempts reached, redirecting to report page");
      toast({
        title: "Letter Generation Issue",
        description: "Unable to load dispute letters. Redirecting to upload page to try again.",
      });
      
      setTimeout(() => {
        navigate('/upload-report');
      }, 1500);
    }
    else if (sessionStorage.getItem('autoGeneratedLetter') === 'true' && !lettersLoaded) {
      console.log("[DisputeLetters] Auto-generated flag is true but no valid letters found, attempt:", loadAttempts + 1);
      
      // Only show toast on first attempt
      if (loadAttempts === 0) {
        toast({
          title: "Loading Letters",
          description: "Attempting to load your generated dispute letters...",
        });
      }
      
      // Increment load attempts
      setLoadAttempts(prev => prev + 1);
      
      // If we've reached the limit, redirect
      if (loadAttempts >= 2) {
        toast({
          title: "Letter Generation Issue",
          description: "The generated letters could not be loaded. Returning to report page to try again.",
        });
        
        setTimeout(() => {
          navigate('/upload-report');
        }, 1500);
      }
    }
  }, [toast, profile, navigate, user, lettersLoaded, loadAttempts]);

  return (
    <DisputeLettersPage testMode={false} requirePayment={true} />
  );
};

export default DisputeLetters;
