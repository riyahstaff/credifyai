
import React, { useEffect, useState } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import DisputeLettersPage from '../components/disputes/letters/DisputeLettersPage';
import { useToast } from '@/hooks/use-toast';
import { useAuth } from '@/contexts/auth';

const DisputeLetters = () => {
  const { toast } = useToast();
  const location = useLocation();
  const navigate = useNavigate();
  const { profile, user } = useAuth();
  const [lettersLoaded, setLettersLoaded] = useState(false);
  const [loadAttempts, setLoadAttempts] = useState(0);
  
  const searchParams = new URLSearchParams(location.search);
  const testMode = searchParams.get('testMode') === 'true';
  
  const hasTestSubscription = sessionStorage.getItem('testModeSubscription') === 'true';

  useEffect(() => {
    console.log("DisputeLetters page: Test mode is", testMode ? "active" : "inactive");
    console.log("DisputeLetters page: Test subscription is", hasTestSubscription ? "active" : "inactive");
    console.log("DisputeLetters page: User auth state:", user ? "Logged in" : "Not logged in");
    console.log("DisputeLetters page: Profile:", profile ? `Profile loaded (${profile.full_name || 'no name'})` : "No profile");
    
    // Store profile data in localStorage for letter generation
    if (profile) {
      localStorage.setItem('userProfile', JSON.stringify(profile));
      
      if (profile.full_name) {
        localStorage.setItem('userName', profile.full_name);
      }
    }
    
    if (!hasTestSubscription && !profile?.has_subscription) {
      console.log("Setting test subscription to allow viewing dispute letters");
      sessionStorage.setItem('testModeSubscription', 'true');
    }
    
    const autoGeneratedFlag = sessionStorage.getItem('autoGeneratedLetter');
    const pendingLetter = sessionStorage.getItem('pendingDisputeLetter');
    const generatedLetters = sessionStorage.getItem('generatedDisputeLetters');
    const forceReload = sessionStorage.getItem('forceLettersReload');
    const letterGenerationComplete = sessionStorage.getItem('letterGenerationComplete');
    
    console.log("[DisputeLetters] Checking for letter flags");
    console.log("[DisputeLetters] autoGeneratedFlag:", autoGeneratedFlag);
    console.log("[DisputeLetters] pendingLetter:", pendingLetter ? "Present" : "Not present");
    console.log("[DisputeLetters] generatedLetters:", generatedLetters ? "Present" : "Not present");
    console.log("[DisputeLetters] forceReload:", forceReload);
    console.log("[DisputeLetters] letterGenerationComplete:", letterGenerationComplete);
    console.log("[DisputeLetters] loadAttempts:", loadAttempts);
    
    let validLetters = false;
    
    if (pendingLetter) {
      try {
        const letterObj = JSON.parse(pendingLetter);
        if (letterObj && letterObj.content && letterObj.content.length > 0) {
          validLetters = true;
          console.log("[DisputeLetters] Letter content found, length:", letterObj.content.length);
          
          if (letterObj.content.includes("Sample dispute letter content") || 
              letterObj.content.length < 100) {
            console.log("[DisputeLetters] Found placeholder content, regenerating letter");
            toast({
              title: "Regenerating Letter",
              description: "The previous letter contained placeholder content. Generating a proper letter now.",
            });
            
            setTimeout(() => {
              navigate('/upload-report' + (testMode ? '?testMode=true' : ''));
            }, 2000);
          }
        } else {
          console.warn("[DisputeLetters] Found letter with invalid/placeholder content");
        }
      } catch (e) {
        console.error("[DisputeLetters] Error parsing letter:", e);
      }
    }
    
    if (validLetters) {
      console.log("[DisputeLetters] Valid letters found in storage");
      setLettersLoaded(true);
    } 
    else if (loadAttempts >= 3) {
      console.log("[DisputeLetters] Maximum load attempts reached, redirecting to report page");
      toast({
        title: "Letter Generation Issue",
        description: "Unable to load dispute letters. Redirecting to upload page to try again.",
      });
      
      setTimeout(() => {
        navigate('/upload-report' + (testMode ? '?testMode=true' : ''));
      }, 1500);
    }
    else if (autoGeneratedFlag === 'true' && !lettersLoaded) {
      console.log("[DisputeLetters] Auto-generated flag is true but no valid letters found, attempt:", loadAttempts + 1);
      
      // Only show toast on first attempt
      if (loadAttempts === 0) {
        toast({
          title: "Loading Letters",
          description: "Attempting to load your generated dispute letters...",
        });
      }
      
      // Increment load attempts
      setLoadAttempts(prev => prev + 1);
      
      // If we've reached the limit, redirect
      if (loadAttempts >= 2) {
        toast({
          title: "Letter Generation Issue",
          description: "The generated letters could not be loaded. Returning to report page to try again.",
        });
        
        setTimeout(() => {
          navigate('/upload-report' + (testMode ? '?testMode=true' : ''));
        }, 1500);
      }
    }
  }, [toast, testMode, hasTestSubscription, profile, navigate, user, lettersLoaded, loadAttempts]);

  return (
    <DisputeLettersPage testMode={testMode} />
  );
};

export default DisputeLetters;
